# JVM åŸºç¡€ - ç±»å­—èŠ‚ç è¯¦è§£

æºä»£ç é€šè¿‡ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†é€šè¿‡ç±»åŠ è½½å­ç³»ç»Ÿè¿›è¡ŒåŠ è½½åˆ°JVMä¸­è¿è¡Œã€‚

## å¤šè¯­è¨€ç¼–è¯‘ä¸ºå­—èŠ‚ç åœ¨JVMè¿è¡Œ

è®¡ç®—æœºæ˜¯ä¸èƒ½ç›´æ¥è¿è¡Œjavaä»£ç çš„ï¼Œå¿…é¡»è¦å…ˆè¿è¡Œjavaè™šæ‹Ÿæœºï¼Œå†ç”±javaè™šæ‹Ÿæœºè¿è¡Œç¼–è¯‘åçš„javaä»£ç ã€‚è¿™ä¸ªç¼–è¯‘åçš„javaä»£ç ï¼Œå°±æ˜¯æœ¬æ–‡è¦ä»‹ç»çš„javaå­—èŠ‚ç ã€‚

ä¸ºä»€ä¹ˆjvmä¸èƒ½ç›´æ¥è¿è¡Œjavaä»£ç å‘¢ï¼Œè¿™æ˜¯å› ä¸ºåœ¨cpuå±‚é¢çœ‹æ¥è®¡ç®—æœºä¸­æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ä¸€ä¸ªä¸ªæŒ‡ä»¤çš„è¿è¡Œæ±‡é›†è€Œæˆçš„ï¼Œjavaæ˜¯é«˜çº§è¯­è¨€ï¼Œåªæœ‰äººç±»æ‰èƒ½ç†è§£å…¶é€»è¾‘ï¼Œè®¡ç®—æœºæ˜¯æ— æ³•è¯†åˆ«çš„ï¼Œæ‰€ä»¥javaä»£ç å¿…é¡»è¦å…ˆç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼Œjvmæ‰èƒ½æ­£ç¡®è¯†åˆ«ä»£ç è½¬æ¢åçš„æŒ‡ä»¤å¹¶å°†å…¶è¿è¡Œã€‚

- Javaä»£ç é—´æ¥ç¿»è¯‘æˆå­—èŠ‚ç ï¼Œå‚¨å­˜å­—èŠ‚ç çš„æ–‡ä»¶å†äº¤ç”±è¿è¡Œäºä¸åŒå¹³å°ä¸Šçš„JVMè™šæ‹Ÿæœºå»è¯»å–æ‰§è¡Œï¼Œä»è€Œå®ç°ä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œçš„ç›®çš„ã€‚
- JVMä¹Ÿä¸å†åªæ”¯æŒJavaï¼Œç”±æ­¤è¡ç”Ÿå‡ºäº†è®¸å¤šåŸºäºJVMçš„ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚Groovy, Scala, Koltinç­‰ç­‰ã€‚

![java-jvm-class-1](Images/java-jvm-class-1.png)

## Javaå­—èŠ‚ç æ–‡ä»¶

classæ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä»¥8ä½å­—èŠ‚ä¸ºåŸºç¡€å•ä½çš„äºŒè¿›åˆ¶æµï¼Œå„ä¸ªæ•°æ®é¡¹ç›®ä¸¥æ ¼æŒ‰ç…§é¡ºåºç´§å‡‘çš„æ’åˆ—åœ¨classæ–‡ä»¶ä¸­ã€‚jvmæ ¹æ®å…¶ç‰¹å®šçš„è§„åˆ™è§£æè¯¥äºŒè¿›åˆ¶æ•°æ®ï¼Œä»è€Œå¾—åˆ°ç›¸å…³ä¿¡æ¯ã€‚

Classæ–‡ä»¶é‡‡ç”¨ä¸€ç§ä¼ªç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼Œå®ƒæœ‰ä¸¤ç§ç±»å‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨ã€‚è¿™é‡Œæš‚ä¸è¯¦ç»†çš„è®²ã€‚

æœ¬æ–‡å°†é€šè¿‡ç®€å•çš„javaä¾‹å­ç¼–è¯‘åçš„æ–‡ä»¶æ¥ç†è§£ã€‚

### Classæ–‡ä»¶çš„ç»“æ„å±æ€§

åœ¨ç†è§£ä¹‹å‰å…ˆä»æ•´ä½“çœ‹ä¸‹javaå­—èŠ‚ç æ–‡ä»¶åŒ…å«äº†å“ªäº›ç±»å‹çš„æ•°æ®ï¼š

![java-jvm-class-2](Images/java-jvm-class-2.png)



### ä»ä¸€ä¸ªä¾‹å­å¼€å§‹

ä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥é€æ­¥è®²è§£å­—èŠ‚ç ã€‚

```java
//Main.java
public class Main {
    
    private int m;
    
    public int inc() {
        return m + 1;
    }
} 
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤, å¯ä»¥åœ¨å½“å‰æ‰€åœ¨è·¯å¾„ä¸‹ç”Ÿæˆä¸€ä¸ªMain.classæ–‡ä»¶ã€‚

```bash
javac Main.java
```

ä»¥æ–‡æœ¬çš„å½¢å¼æ‰“å¼€ç”Ÿæˆçš„classæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```bash
cafe babe 0000 0034 0013 0a00 0400 0f09
0003 0010 0700 1107 0012 0100 016d 0100
0149 0100 063c 696e 6974 3e01 0003 2829
5601 0004 436f 6465 0100 0f4c 696e 654e
756d 6265 7254 6162 6c65 0100 0369 6e63
0100 0328 2949 0100 0a53 6f75 7263 6546
696c 6501 0009 4d61 696e 2e6a 6176 610c
0007 0008 0c00 0500 0601 0010 636f 6d2f
7268 7974 686d 372f 4d61 696e 0100 106a
6176 612f 6c61 6e67 2f4f 626a 6563 7400
2100 0300 0400 0000 0100 0200 0500 0600
0000 0200 0100 0700 0800 0100 0900 0000
1d00 0100 0100 0000 052a b700 01b1 0000
0001 000a 0000 0006 0001 0000 0003 0001
000b 000c 0001 0009 0000 001f 0002 0001
0000 0007 2ab4 0002 0460 ac00 0000 0100
0a00 0000 0600 0100 0000 0800 0100 0d00
0000 0200 0e
```

- æ–‡ä»¶å¼€å¤´çš„4ä¸ªå­—èŠ‚("cafe babe")ç§°ä¹‹ä¸º `é­”æ•°`ï¼Œå”¯æœ‰ä»¥"cafe babe"å¼€å¤´çš„classæ–‡ä»¶æ–¹å¯è¢«è™šæ‹Ÿæœºæ‰€æ¥å—ï¼Œè¿™4ä¸ªå­—èŠ‚å°±æ˜¯å­—èŠ‚ç æ–‡ä»¶çš„èº«ä»½è¯†åˆ«ã€‚
- 0000æ˜¯ç¼–è¯‘å™¨jdkç‰ˆæœ¬çš„æ¬¡ç‰ˆæœ¬å·0ï¼Œ0034è½¬åŒ–ä¸ºåè¿›åˆ¶æ˜¯52,æ˜¯ä¸»ç‰ˆæœ¬å·ï¼Œjavaçš„ç‰ˆæœ¬å·ä»45å¼€å§‹ï¼Œé™¤1.0å’Œ1.1éƒ½æ˜¯ä½¿ç”¨45.xå¤–,ä»¥åæ¯å‡ä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å·åŠ ä¸€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘ç”Ÿæˆè¯¥classæ–‡ä»¶çš„jdkç‰ˆæœ¬ä¸º1.8.0ã€‚

é€šè¿‡java -versionå‘½ä»¤ç¨åŠ éªŒè¯, å¯å¾—ç»“æœã€‚

```java
Java(TM) SE Runtime Environment (build 1.8.0_131-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)
```

ç»§ç»­å¾€ä¸‹æ˜¯å¸¸é‡æ± ... çŸ¥é“æ˜¯è¿™ä¹ˆåˆ†æçš„å°±å¯ä»¥äº†ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡å·¥å…·åç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶ç»§ç»­å»çœ‹ã€‚

### åç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶

> ä½¿ç”¨åˆ°javaå†…ç½®çš„ä¸€ä¸ªåç¼–è¯‘å·¥å…·javapå¯ä»¥åç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶, ç”¨æ³•: `javap <options> <classes>`

å…¶ä¸­`<options>`é€‰é¡¹åŒ…æ‹¬:

```bash
  -help  --help  -?        è¾“å‡ºæ­¤ç”¨æ³•æ¶ˆæ¯
  -version                 ç‰ˆæœ¬ä¿¡æ¯
  -v  -verbose             è¾“å‡ºé™„åŠ ä¿¡æ¯
  -l                       è¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨
  -public                  ä»…æ˜¾ç¤ºå…¬å…±ç±»å’Œæˆå‘˜
  -protected               æ˜¾ç¤ºå—ä¿æŠ¤çš„/å…¬å…±ç±»å’Œæˆå‘˜
  -package                 æ˜¾ç¤ºç¨‹åºåŒ…/å—ä¿æŠ¤çš„/å…¬å…±ç±»
                           å’Œæˆå‘˜ (é»˜è®¤)
  -p  -private             æ˜¾ç¤ºæ‰€æœ‰ç±»å’Œæˆå‘˜
  -c                       å¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–
  -s                       è¾“å‡ºå†…éƒ¨ç±»å‹ç­¾å
  -sysinfo                 æ˜¾ç¤ºæ­£åœ¨å¤„ç†çš„ç±»çš„
                           ç³»ç»Ÿä¿¡æ¯ (è·¯å¾„, å¤§å°, æ—¥æœŸ, MD5 æ•£åˆ—)
  -constants               æ˜¾ç¤ºæœ€ç»ˆå¸¸é‡
  -classpath <path>        æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®
  -cp <path>               æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®
  -bootclasspath <path>    è¦†ç›–å¼•å¯¼ç±»æ–‡ä»¶çš„ä½ç½®   
```

è¾“å…¥å‘½ä»¤`javap -verbose -p Main.class`æŸ¥çœ‹è¾“å‡ºå†…å®¹:

```java
Classfile /E:/JavaCode/TestProj/out/production/TestProj/com/rhythm7/Main.class
  Last modified 2018-4-7; size 362 bytes
  MD5 checksum 4aed8540b098992663b7ba08c65312de
  Compiled from "Main.java"
public class com.rhythm7.Main
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #4.#18         // java/lang/Object."<init>":()V
   #2 = Fieldref           #3.#19         // com/rhythm7/Main.m:I
   #3 = Class              #20            // com/rhythm7/Main
   #4 = Class              #21            // java/lang/Object
   #5 = Utf8               m
   #6 = Utf8               I
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lcom/rhythm7/Main;
  #14 = Utf8               inc
  #15 = Utf8               ()I
  #16 = Utf8               SourceFile
  #17 = Utf8               Main.java
  #18 = NameAndType        #7:#8          // "<init>":()V
  #19 = NameAndType        #5:#6          // m:I
  #20 = Utf8               com/rhythm7/Main
  #21 = Utf8               java/lang/Object
{
  private int m;
    descriptor: I
    flags: ACC_PRIVATE

  public com.rhythm7.Main();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 3: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/rhythm7/Main;

  public int inc();
    descriptor: ()I
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: getfield      #2                  // Field m:I
         4: iconst_1
         5: iadd
         6: ireturn
      LineNumberTable:
        line 8: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       7     0  this   Lcom/rhythm7/Main;
}
SourceFile: "Main.java"  
```

### å­—èŠ‚ç æ–‡ä»¶ä¿¡æ¯

å¼€å¤´çš„7è¡Œä¿¡æ¯åŒ…æ‹¬:Classæ–‡ä»¶å½“å‰æ‰€åœ¨ä½ç½®ï¼Œæœ€åä¿®æ”¹æ—¶é—´ï¼Œæ–‡ä»¶å¤§å°ï¼ŒMD5å€¼ï¼Œç¼–è¯‘è‡ªå“ªä¸ªæ–‡ä»¶ï¼Œç±»çš„å…¨é™å®šåï¼Œjdkæ¬¡ç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬å·ã€‚

ç„¶åç´§æ¥ç€çš„æ˜¯è¯¥ç±»çš„è®¿é—®æ ‡å¿—ï¼šACC_PUBLIC, ACC_SUPERï¼Œè®¿é—®æ ‡å¿—çš„å«ä¹‰å¦‚ä¸‹:

| æ ‡å¿—åç§°       | æ ‡å¿—å€¼ | å«ä¹‰                                                         |
| -------------- | ------ | ------------------------------------------------------------ |
| ACC_PUBLIC     | 0x0001 | æ˜¯å¦ä¸ºPublicç±»å‹                                             |
| ACC_FINAL      | 0x0010 | æ˜¯å¦è¢«å£°æ˜ä¸ºfinalï¼Œåªæœ‰ç±»å¯ä»¥è®¾ç½®                            |
| ACC_SUPER      | 0x0020 | æ˜¯å¦å…è®¸ä½¿ç”¨invokespecialå­—èŠ‚ç æŒ‡ä»¤çš„æ–°è¯­ä¹‰ï¼                |
| ACC_INTERFACE  | 0x0200 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæ¥å£                                             |
| ACC_ABSTRACT   | 0x0400 | æ˜¯å¦ä¸ºabstractç±»å‹ï¼Œå¯¹äºæ¥å£æˆ–è€…æŠ½è±¡ç±»æ¥è¯´ï¼Œæ¬¡æ ‡å¿—å€¼ä¸ºçœŸï¼Œå…¶ä»–ç±»å‹ä¸ºå‡ |
| ACC_SYNTHETIC  | 0x1000 | æ ‡å¿—è¿™ä¸ªç±»å¹¶éç”±ç”¨æˆ·ä»£ç äº§ç”Ÿ                                 |
| ACC_ANNOTATION | 0x2000 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæ³¨è§£                                             |
| ACC_ENUM       | 0x4000 | æ ‡å¿—è¿™æ˜¯ä¸€ä¸ªæšä¸¾                                             |

### å¸¸é‡æ± 

`Constant pool`æ„ä¸ºå¸¸é‡æ± ã€‚

å¸¸é‡æ± å¯ä»¥ç†è§£æˆClassæ–‡ä»¶ä¸­çš„èµ„æºä»“åº“ã€‚ä¸»è¦å­˜æ”¾çš„æ˜¯ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡(Literal)å’Œç¬¦å·å¼•ç”¨(Symbolic References)ã€‚å­—é¢é‡ç±»ä¼¼äºjavaä¸­çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œfinalå¸¸é‡ç­‰ï¼Œè€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¸‰ç§:

- ç±»å’Œæ¥å£çš„å…¨é™å®šå(Fully Qualified Name)
- å­—æ®µçš„åç§°å’Œæè¿°ç¬¦å·(Descriptor)
- æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦

ä¸åŒäºC/C++, JVMæ˜¯åœ¨åŠ è½½Classæ–‡ä»¶çš„æ—¶å€™æ‰è¿›è¡Œçš„åŠ¨æ€é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›å­—æ®µå’Œæ–¹æ³•ç¬¦å·å¼•ç”¨åªæœ‰åœ¨è¿è¡ŒæœŸè½¬æ¢åæ‰èƒ½è·å¾—çœŸæ­£çš„å†…å­˜å…¥å£åœ°å€ã€‚å½“è™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œéœ€è¦ä»å¸¸é‡æ± è·å¾—å¯¹åº”çš„ç¬¦å·å¼•ç”¨ï¼Œå†åœ¨ç±»åˆ›å»ºæˆ–è¿è¡Œæ—¶è§£æå¹¶ç¿»è¯‘åˆ°å…·ä½“çš„å†…å­˜åœ°å€ä¸­ã€‚ ç›´æ¥é€šè¿‡åç¼–è¯‘æ–‡ä»¶æ¥æŸ¥çœ‹å­—èŠ‚ç å†…å®¹ï¼š

```java
#1 = Methodref          #4.#18         // java/lang/Object."<init>":()V
#4 = Class              #21            // java/lang/Object
#7 = Utf8               <init>
#8 = Utf8               ()V
#18 = NameAndType        #7:#8          // "<init>":()V
#21 = Utf8               java/lang/Object
```

**ç¬¬ä¸€ä¸ªå¸¸é‡**æ˜¯ä¸€ä¸ªæ–¹æ³•å®šä¹‰ï¼ŒæŒ‡å‘äº†ç¬¬4å’Œç¬¬18ä¸ªå¸¸é‡ã€‚ä»¥æ­¤ç±»æ¨æŸ¥çœ‹ç¬¬4å’Œç¬¬18ä¸ªå¸¸é‡ã€‚æœ€åå¯ä»¥æ‹¼æ¥æˆç¬¬ä¸€ä¸ªå¸¸é‡å³ä¾§çš„æ³¨é‡Šå†…å®¹:

```java
java/lang/Object."<init>":()V  
```

è¿™æ®µå¯ä»¥ç†è§£ä¸ºè¯¥ç±»çš„å®ä¾‹æ„é€ å™¨çš„å£°æ˜ï¼Œç”±äºMainç±»æ²¡æœ‰é‡å†™æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯çˆ¶ç±»çš„æ„é€ æ–¹æ³•ã€‚æ­¤å¤„ä¹Ÿè¯´æ˜äº†Mainç±»çš„ç›´æ¥çˆ¶ç±»æ˜¯Objectã€‚ è¯¥æ–¹æ³•é»˜è®¤è¿”å›å€¼æ˜¯V, ä¹Ÿå°±æ˜¯voidï¼Œæ— è¿”å›å€¼ã€‚

**ç¬¬äºŒä¸ªå¸¸é‡**åŒç†å¯å¾—:

```java
#2 = Fieldref           #3.#19         // com/rhythm7/Main.m:I
#3 = Class              #20            // com/rhythm7/Main
#5 = Utf8               m
#6 = Utf8               I
#19 = NameAndType        #5:#6          // m:I
#20 = Utf8               com/rhythm7/Main
```

å¤åˆ¶ä»£ç æ­¤å¤„å£°æ˜äº†ä¸€ä¸ªå­—æ®µmï¼Œç±»å‹ä¸ºI, Iå³æ˜¯intç±»å‹ã€‚å…³äºå­—èŠ‚ç çš„ç±»å‹å¯¹åº”å¦‚ä¸‹ï¼š

| æ ‡è¯†å­—ç¬¦ | å«ä¹‰                                       |
| -------- | ------------------------------------------ |
|          | B                                          |
| C        | åŸºæœ¬ç±»å‹char                               |
| D        | åŸºæœ¬ç±»å‹double                             |
| F        | åŸºæœ¬ç±»å‹float                              |
| I        | åŸºæœ¬ç±»å‹int                                |
| J        | åŸºæœ¬ç±»å‹long                               |
| S        | åŸºæœ¬ç±»å‹short                              |
| Z        | åŸºæœ¬ç±»å‹boolean                            |
| V        | ç‰¹æ®Šç±»å‹void                               |
| L        | å¯¹è±¡ç±»å‹ï¼Œä»¥åˆ†å·ç»“å°¾ï¼Œå¦‚Ljava/lang/Object; |

å¯¹äºæ•°ç»„ç±»å‹ï¼Œæ¯ä¸€ä½ä½¿ç”¨ä¸€ä¸ªå‰ç½®çš„`[`å­—ç¬¦æ¥æè¿°ï¼Œå¦‚å®šä¹‰ä¸€ä¸ª`java.lang.String[][]`ç±»å‹çš„ç»´æ•°ç»„ï¼Œå°†è¢«è®°å½•ä¸º`[[Ljava/lang/String;`

### æ–¹æ³•è¡¨é›†åˆ

åœ¨å¸¸é‡æ± ä¹‹åçš„æ˜¯å¯¹ç±»å†…éƒ¨çš„æ–¹æ³•æè¿°ï¼Œåœ¨å­—èŠ‚ç ä¸­ä»¥è¡¨çš„é›†åˆå½¢å¼è¡¨ç°ï¼Œæš‚ä¸”ä¸ç®¡å­—èŠ‚ç æ–‡ä»¶çš„16è¿›åˆ¶æ–‡ä»¶å†…å®¹å¦‚ä½•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åç¼–è¯‘åçš„å†…å®¹ã€‚

```java
private int m;
  descriptor: I
  flags: ACC_PRIVATE 
```

æ­¤å¤„å£°æ˜äº†ä¸€ä¸ªç§æœ‰å˜é‡mï¼Œç±»å‹ä¸ºintï¼Œè¿”å›å€¼ä¸ºint

```java
public com.rhythm7.Main();
   descriptor: ()V
   flags: ACC_PUBLIC
   Code:
     stack=1, locals=1, args_size=1
        0: aload_0
        1: invokespecial #1                  // Method java/lang/Object."<init>":()V
        4: return
     LineNumberTable:
       line 3: 0
     LocalVariableTable:
       Start  Length  Slot  Name   Signature
           0       5     0  this   Lcom/rhythm7/Main;
```

è¿™é‡Œæ˜¯æ„é€ æ–¹æ³•ï¼šMain()ï¼Œè¿”å›å€¼ä¸ºvoid, å…¬å¼€æ–¹æ³•ã€‚

codeå†…çš„ä¸»è¦å±æ€§ä¸º:

- **stack**: æœ€å¤§æ“ä½œæ•°æ ˆï¼ŒJVMè¿è¡Œæ—¶ä¼šæ ¹æ®è¿™ä¸ªå€¼æ¥åˆ†é…æ ˆå¸§(Frame)ä¸­çš„æ“ä½œæ ˆæ·±åº¦,æ­¤å¤„ä¸º1
- **locals**: å±€éƒ¨å˜é‡æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼Œå•ä½ä¸ºSlot, Slotæ˜¯è™šæ‹Ÿæœºä¸ºå±€éƒ¨å˜é‡åˆ†é…å†…å­˜æ—¶æ‰€ä½¿ç”¨çš„æœ€å°å•ä½ï¼Œä¸º4ä¸ªå­—èŠ‚å¤§å°ã€‚æ–¹æ³•å‚æ•°(åŒ…æ‹¬å®ä¾‹æ–¹æ³•ä¸­çš„éšè—å‚æ•°this)ï¼Œæ˜¾ç¤ºå¼‚å¸¸å¤„ç†å™¨çš„å‚æ•°(try catchä¸­çš„catchå—æ‰€å®šä¹‰çš„å¼‚å¸¸)ï¼Œæ–¹æ³•ä½“ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡éƒ½éœ€è¦ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨æ¥å­˜æ”¾ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œlocalsçš„å¤§å°å¹¶ä¸ä¸€å®šç­‰äºæ‰€æœ‰å±€éƒ¨å˜é‡æ‰€å çš„Slotä¹‹å’Œï¼Œå› ä¸ºå±€éƒ¨å˜é‡ä¸­çš„Slotæ˜¯å¯ä»¥é‡ç”¨çš„ã€‚
- **args_size**: æ–¹æ³•å‚æ•°çš„ä¸ªæ•°ï¼Œè¿™é‡Œæ˜¯1ï¼Œå› ä¸ºæ¯ä¸ªå®ä¾‹æ–¹æ³•éƒ½ä¼šæœ‰ä¸€ä¸ªéšè—å‚æ•°this
- **attribute_info**: æ–¹æ³•ä½“å†…å®¹ï¼Œ0,1,4ä¸ºå­—èŠ‚ç "è¡Œå·"ï¼Œè¯¥æ®µä»£ç çš„æ„æ€æ˜¯å°†ç¬¬ä¸€ä¸ªå¼•ç”¨ç±»å‹æœ¬åœ°å˜é‡æ¨é€è‡³æ ˆé¡¶ï¼Œç„¶åæ‰§è¡Œè¯¥ç±»å‹çš„å®ä¾‹æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¸¸é‡æ± å­˜æ”¾çš„ç¬¬ä¸€ä¸ªå˜é‡ï¼Œä¹Ÿå°±æ˜¯æ³¨é‡Šé‡Œçš„"java/lang/Object.""ğŸ˜¦)V", ç„¶åæ‰§è¡Œè¿”å›è¯­å¥ï¼Œç»“æŸæ–¹æ³•ã€‚
- **LineNumberTable**: è¯¥å±æ€§çš„ä½œç”¨æ˜¯æè¿°æºç è¡Œå·ä¸å­—èŠ‚ç è¡Œå·(å­—èŠ‚ç åç§»é‡)ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚å¯ä»¥ä½¿ç”¨ -g:none æˆ–-g:linesé€‰é¡¹æ¥å–æ¶ˆæˆ–è¦æ±‚ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ï¼Œå¦‚æœé€‰æ‹©ä¸ç”ŸæˆLineNumberTableï¼Œå½“ç¨‹åºè¿è¡Œå¼‚å¸¸æ—¶å°†æ— æ³•è·å–åˆ°å‘ç”Ÿå¼‚å¸¸çš„æºç è¡Œå·ï¼Œä¹Ÿæ— æ³•æŒ‰ç…§æºç çš„è¡Œæ•°æ¥è°ƒè¯•ç¨‹åºã€‚
- **LocalVariableTable**: è¯¥å±æ€§çš„ä½œç”¨æ˜¯æè¿°å¸§æ ˆä¸­å±€éƒ¨å˜é‡ä¸æºç ä¸­å®šä¹‰çš„å˜é‡ä¹‹é—´çš„å…³ç³»ã€‚å¯ä»¥ä½¿ç”¨ -g:none æˆ– -g:varsæ¥å–æ¶ˆæˆ–ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ç”Ÿæˆè¿™é¡¹ä¿¡æ¯ï¼Œé‚£ä¹ˆå½“åˆ«äººå¼•ç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå°†æ— æ³•è·å–åˆ°å‚æ•°åç§°ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯arg0, arg1è¿™æ ·çš„å ä½ç¬¦ã€‚ start è¡¨ç¤ºè¯¥å±€éƒ¨å˜é‡åœ¨å“ªä¸€è¡Œå¼€å§‹å¯è§ï¼Œlengthè¡¨ç¤ºå¯è§è¡Œæ•°ï¼ŒSlotä»£è¡¨æ‰€åœ¨å¸§æ ˆä½ç½®ï¼ŒNameæ˜¯å˜é‡åç§°ï¼Œç„¶åæ˜¯ç±»å‹ç­¾åã€‚

åŒç†å¯ä»¥åˆ†æMainç±»ä¸­çš„å¦ä¸€ä¸ªæ–¹æ³•"inc()":

æ–¹æ³•ä½“å†…çš„å†…å®¹æ˜¯ï¼šå°†thiså…¥æ ˆï¼Œè·å–å­—æ®µ#2å¹¶ç½®äºæ ˆé¡¶, å°†intç±»å‹çš„1å…¥æ ˆï¼Œå°†æ ˆå†…é¡¶éƒ¨çš„ä¸¤ä¸ªæ•°å€¼ç›¸åŠ ï¼Œè¿”å›ä¸€ä¸ªintç±»å‹çš„å€¼ã€‚

### ç±»å

æœ€åå¾ˆæ˜¾ç„¶æ˜¯æºç æ–‡ä»¶ï¼š

```java
SourceFile: "Main.java"
```

## å†çœ‹ä¸¤ä¸ªç¤ºä¾‹

### åˆ†ætry-catch-finally

é€šè¿‡ä»¥ä¸Šä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå¯ä»¥å¤§è‡´äº†è§£æºç è¢«ç¼–è¯‘æˆå­—èŠ‚ç åæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚ ä¸‹é¢åˆ©ç”¨æ‰€å­¦çš„çŸ¥è¯†ç‚¹æ¥åˆ†æä¸€äº›Javaé—®é¢˜:

```java
public class TestCode {
    public int foo() {
        int x;
        try {
            x = 1;
            return x;
        } catch (Exception e) {
            x = 2;
            return x;
        } finally {
            x = 3;
        }
    }
}
```

è¯•é—®å½“ä¸å‘ç”Ÿå¼‚å¸¸å’Œå‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œfoo()çš„è¿”å›å€¼åˆ†åˆ«æ˜¯å¤šå°‘ã€‚

```java
javac TestCode.java
javap -verbose TestCode.class  
```

æŸ¥çœ‹å­—èŠ‚ç çš„fooæ–¹æ³•å†…å®¹:

```java
public int foo();
    descriptor: ()I
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=5, args_size=1
         0: iconst_1 //intå‹1å…¥æ ˆ ->æ ˆé¡¶=1
         1: istore_1 //å°†æ ˆé¡¶çš„intå‹æ•°å€¼å­˜å…¥ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ ->å±€éƒ¨2=1
         2: iload_1 //å°†ç¬¬äºŒä¸ªintå‹å±€éƒ¨å˜é‡æ¨é€è‡³æ ˆé¡¶ ->æ ˆé¡¶=1
         3: istore_2 //!!å°†æ ˆé¡¶intå‹æ•°å€¼å­˜å…¥ç¬¬ä¸‰ä¸ªå±€éƒ¨å˜é‡ ->å±€éƒ¨3=1
         
         4: iconst_3 //intå‹3å…¥æ ˆ ->æ ˆé¡¶=3
         5: istore_1 //å°†æ ˆé¡¶çš„intå‹æ•°å€¼å­˜å…¥ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ ->å±€éƒ¨2=3
         6: iload_2 //!!å°†ç¬¬ä¸‰ä¸ªintå‹å±€éƒ¨å˜é‡æ¨é€è‡³æ ˆé¡¶ ->æ ˆé¡¶=1
         7: ireturn //ä»å½“å‰æ–¹æ³•è¿”å›æ ˆé¡¶intæ•°å€¼ ->1
         
         8: astore_2 // ->å±€éƒ¨3=Exception
         9: iconst_2 // ->æ ˆé¡¶=2
        10: istore_1 // ->å±€éƒ¨2=2
        11: iload_1 //->æ ˆé¡¶=2
        12: istore_3 //!! ->å±€éƒ¨4=2
        
        13: iconst_3 // ->æ ˆé¡¶=3
        14: istore_1 // ->å±€éƒ¨1=3
        15: iload_3 //!! ->æ ˆé¡¶=2
        16: ireturn // -> 2
        
        17: astore        4 //å°†æ ˆé¡¶å¼•ç”¨å‹æ•°å€¼å­˜å…¥ç¬¬äº”ä¸ªå±€éƒ¨å˜é‡=any
        19: iconst_3 //å°†intå‹æ•°å€¼3å…¥æ ˆ -> æ ˆé¡¶3
        20: istore_1 //å°†æ ˆé¡¶ç¬¬ä¸€ä¸ªintæ•°å€¼å­˜å…¥ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ -> å±€éƒ¨2=3
        21: aload         4 //å°†å±€éƒ¨ç¬¬äº”ä¸ªå±€éƒ¨å˜é‡(å¼•ç”¨å‹)æ¨é€è‡³æ ˆé¡¶
        23: athrow //å°†æ ˆé¡¶çš„å¼‚å¸¸æŠ›å‡º
      Exception table:
         from    to  target type
             0     4     8   Class java/lang/Exception //0åˆ°4è¡Œå¯¹åº”çš„å¼‚å¸¸ï¼Œå¯¹åº”#8ä¸­å‚¨å­˜çš„å¼‚å¸¸
             0     4    17   any //Exeptionä¹‹å¤–çš„å…¶ä»–å¼‚å¸¸
             8    13    17   any
            17    19    17   any
```

åœ¨å­—èŠ‚ç çš„4,5ï¼Œä»¥åŠ13,14ä¸­æ‰§è¡Œçš„æ˜¯åŒä¸€ä¸ªæ“ä½œï¼Œå°±æ˜¯å°†intå‹çš„3å…¥æ“ä½œæ•°æ ˆé¡¶ï¼Œå¹¶å­˜å…¥ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æºç åœ¨finallyè¯­å¥å—ä¸­å†…å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJVMåœ¨å¤„ç†å¼‚å¸¸æ—¶ï¼Œä¼šåœ¨æ¯ä¸ªå¯èƒ½çš„åˆ†æ”¯éƒ½å°†finallyè¯­å¥é‡å¤æ‰§è¡Œä¸€éã€‚

é€šè¿‡ä¸€æ­¥æ­¥åˆ†æå­—èŠ‚ç ï¼Œå¯ä»¥å¾—å‡ºæœ€åçš„è¿è¡Œç»“æœæ˜¯ï¼š

- ä¸å‘ç”Ÿå¼‚å¸¸æ—¶: return 1
- å‘ç”Ÿå¼‚å¸¸æ—¶: return 2
- å‘ç”ŸéExceptionåŠå…¶å­ç±»çš„å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œä¸è¿”å›å€¼

> ä»¥ä¸Šä¾‹å­æ¥è‡ªäºã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº JVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µã€‹, å…³äºè™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤è¡¨ï¼Œä¹Ÿå¯ä»¥åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº JVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µ-é™„å½•Bã€‹ä¸­è·å–ã€‚

### kotlin å‡½æ•°æ‰©å±•çš„å®ç°

kotlinæä¾›äº†æ‰©å±•å‡½æ•°çš„è¯­è¨€ç‰¹æ€§ï¼Œå€ŸåŠ©è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»»æ„å¯¹è±¡æ·»åŠ è‡ªå®šä¹‰æ–¹æ³•ã€‚

ä»¥ä¸‹ç¤ºä¾‹ä¸ºObjectæ·»åŠ "sayHello"æ–¹æ³•

```java
//SayHello.kt
package com.rhythm7

fun Any.sayHello() {
    println("Hello")
}  
```

ç¼–è¯‘åï¼Œä½¿ç”¨javapæŸ¥çœ‹ç”ŸæˆSayHelloKt.classæ–‡ä»¶çš„å­—èŠ‚ç ã€‚

```java
Classfile /E:/JavaCode/TestProj/out/production/TestProj/com/rhythm7/SayHelloKt.class
Last modified 2018-4-8; size 958 bytes
 MD5 checksum 780a04b75a91be7605cac4655b499f19
 Compiled from "SayHello.kt"
public final class com.rhythm7.SayHelloKt
 minor version: 0
 major version: 52
 flags: ACC_PUBLIC, ACC_FINAL, ACC_SUPER
Constant pool:
    //çœç•¥å¸¸é‡æ± éƒ¨åˆ†å­—èŠ‚ç 
{
 public static final void sayHello(java.lang.Object);
   descriptor: (Ljava/lang/Object;)V
   flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL
   Code:
     stack=2, locals=2, args_size=1
        0: aload_0
        1: ldc           #9                  // String $receiver
        3: invokestatic  #15                 // Method kotlin/jvm/internal/Intrinsics.checkParameterIsNotNull:(Ljava/lang/Object;Ljava/lang/String;)V
        6: ldc           #17                 // String Hello
        8: astore_1
        9: getstatic     #23                 // Field java/lang/System.out:Ljava/io/PrintStream;
       12: aload_1
       13: invokevirtual #28                 // Method java/io/PrintStream.println:(Ljava/lang/Object;)V
       16: return
     LocalVariableTable:
       Start  Length  Slot  Name   Signature
           0      17     0 $receiver   Ljava/lang/Object;
     LineNumberTable:
       line 4: 6
       line 5: 16
   RuntimeInvisibleParameterAnnotations:
     0:
       0: #7()
}
SourceFile: "SayHello.kt"
```

è§‚å¯Ÿå¤´éƒ¨å‘ç°,koltinä¸ºæ–‡ä»¶SayHelloç”Ÿæˆäº†ä¸€ä¸ªç±»ï¼Œç±»å"com.rhythm7.SayHelloKt".

ç”±äºæˆ‘ä»¬ä¸€å¼€å§‹ç¼–å†™SayHello.ktæ—¶å¹¶ä¸å¸Œæœ›SayHelloæ˜¯ä¸€ä¸ªå¯å®ä¾‹åŒ–çš„å¯¹è±¡ç±»ï¼Œæ‰€ä»¥ï¼ŒSayHelloKtæ˜¯æ— æ³•è¢«å®ä¾‹åŒ–çš„ï¼ŒSayHelloKtå¹¶æ²¡æœ‰ä»»ä½•ä¸€ä¸ªæ„é€ å™¨ã€‚

å†è§‚å¯Ÿå”¯ä¸€çš„ä¸€ä¸ªæ–¹æ³•ï¼šå‘ç°Any.sayHello()çš„å…·ä½“å®ç°æ˜¯é™æ€ä¸å¯å˜æ–¹æ³•çš„å½¢å¼:

```java
public static final void sayHello(java.lang.Object);
```

æ‰€ä»¥å½“æˆ‘ä»¬åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨Any.sayHello()æ—¶ï¼Œäº‹å®ä¸Šç­‰åŒäºè°ƒç”¨javaçš„SayHelloKt.sayHello(Object)æ–¹æ³•ã€‚

é¡ºä¾¿ä¸€æçš„æ˜¯ï¼Œå½“æ‰©å±•çš„æ–¹æ³•ä¸ºAnyæ—¶ï¼Œæ„å‘³ç€Anyæ˜¯non-nullçš„ï¼Œè¿™æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ–¹æ³•ä½“çš„å¼€å¤´æ£€æŸ¥å‚æ•°çš„éç©ºï¼Œå³è°ƒç”¨ `kotlin.jvm.internal.Intrinsics.checkParameterIsNotNull(Object value, String paramName)` æ–¹æ³•æ¥æ£€æŸ¥ä¼ å…¥çš„Anyç±»å‹å¯¹è±¡æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœæˆ‘ä»¬æ‰©å±•çš„å‡½æ•°ä¸º`Any?.sayHello()`ï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘åçš„æ–‡ä»¶ä¸­åˆ™ä¸ä¼šæœ‰è¿™æ®µå­—èŠ‚ç çš„å‡ºç°ã€‚
